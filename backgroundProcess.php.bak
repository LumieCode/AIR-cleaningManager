<?php

// Establish database connection
$databaseHost = "localhost";
$databaseUser = "iva";
$databasePassword = "12345";
$databaseName = "cw";
$conn = mysqli_connect($databaseHost, $databaseUser, $databasePassword, $databaseName);

// Set default timezone
date_default_timezone_set('Africa/Cairo');

// Retrieve users from the "dle_users" table
$selectUsersQuery = "SELECT * FROM dle_users";
if ($usersResult = $conn->query($selectUsersQuery)) {
    while ($userRow = $usersResult->fetch_assoc()) {
        // Get the end time for a specific task and user from the "log_action" table
        $selectEndTimeQuery = "SELECT time_end FROM log_action WHERE task_id = 5 AND user_id = " . $userRow["user_id"];
        $endTimeResult = $conn->query($selectEndTimeQuery);
        if ($endTimeResult->num_rows > 0) {
            $endTimeRow = $endTimeResult->fetch_assoc();
            $givenDatetime = $endTimeRow['time_end'];
            $currentDateTime = new DateTime();
            $givenDatetime = new DateTime($givenDatetime);
            $timeDifference = $currentDateTime->diff($givenDatetime);

            // Check if the time difference is less than 2 days
            if ($timeDifference->days < 2) {
                // Update "cleanerPosition" to 1 for the user
                $updatePositionQuery = "UPDATE dle_users SET cleanerPosition = ? WHERE user_id = ?";
                $completionStatusSend = 1;
                $whoIdSend = $userRow["user_id"];
                $stmt = $conn->prepare($updatePositionQuery);
                $stmt->bind_param("ii", $completionStatusSend, $whoIdSend);

                if ($stmt->execute()) {
                    $successMsg = 'Record updated successfully';
                } else {
                    $errorMsg = 'Error updating record: ' . $stmt->error;
                }
            } else {
                // Update "cleanerPosition" to 0 for the user
                $updatePositionQuery = "UPDATE dle_users SET cleanerPosition = ? WHERE user_id = ?";
                $completionStatusSend = 0;
                $whoIdSend = $userRow["user_id"];
                $stmt = $conn->prepare($updatePositionQuery);
                $stmt->bind_param("ii", $completionStatusSend, $whoIdSend);

                if ($stmt->execute()) {
                    $successMsg = 'Record updated successfully';
                } else {
                    $errorMsg = 'Error updating record: ' . $stmt->error;
                }
            }
        }
    }
}

// Check if today's date is different from the date in the "clean_up" table
$selectResetDateQuery = "SELECT date_Reseted FROM clean_up WHERE 1=1";
$dateResult = $conn->query($selectResetDateQuery);
$dateRow = mysqli_fetch_assoc($dateResult);
$dateInDB = date('Y-m-d', strtotime($dateRow['date_Reseted']));
$today = date('Y-m-d');

if ($today != $dateInDB) {
    // Select user_ids from "dle_users" where cleanerPosition is 1, ordered by difficulty_Elo
    $selectUserIdsQuery = "SELECT user_id FROM dle_users WHERE cleanerPosition = 1 ORDER BY difficulty_Elo";
    $result = $conn->query($selectUserIdsQuery);
    $count = $result->num_rows;
    $userIds = array();

    if ($count > 0) {
        $rows = mysqli_fetch_all($result, MYSQLI_ASSOC);
        $userIds = array_column($rows, 'user_id');
    }

    // Select names from "clean_up" ordered by difficulty
    $selectCleanUpNamesQuery = "SELECT name FROM clean_up ORDER BY difficulty DESC";
    $res = $conn->query($selectCleanUpNamesQuery);
    $cleanUpCount = $res->num_rows;
    $cleanUpNames = array();

    if ($cleanUpCount > 0) {
        $resRows = mysqli_fetch_all($res, MYSQLI_ASSOC);
        $cleanUpNames = array_column($resRows, 'name');
    }

    for ($i = 0; $i < $cleanUpCount; $i++) {
        // Update "date_Reseted" for each row in "clean_up"
        $updateResetDateQuery = "UPDATE clean_up SET date_Reseted = ? WHERE id = ?";
        $stmt = $conn->prepare($updateResetDateQuery);
        $stmt->bind_param("si", date('Y-m-d'), ($i + 2));
        $stmt->execute();
    }

    $taskGroupRemainder = $cleanUpCount % $count;
    $taskGroupSize = ($cleanUpCount - $taskGroupRemainder) / $count;
    $currentRegressor = 0;
    $regressionsLeftUntilTheNextRegressor = $taskGroupSize;

    for ($i = 0; $i < count($cleanUpNames); $i++) {
        if ($regressionsLeftUntilTheNextRegressor == 0) {
            $regressionsLeftUntilTheNextRegressor = $taskGroupSize;
            $currentRegressor++;
        }

        // Update "who_id" for each row in "clean_up"
        $updateWhoIdQuery = "UPDATE clean_up SET who_id = ? WHERE name = ?";
        $stmt = $conn->prepare($updateWhoIdQuery);
        $stmt->bind_param("is", $userIds[$currentRegressor], $cleanUpNames[$i]);
        $stmt->execute();

        // Get task difficulty
        $selectDifficultyQuery = "SELECT difficulty FROM clean_up WHERE name = ?";
        $stmt = $conn->prepare($selectDifficultyQuery);
        $stmt->bind_param("s", $cleanUpNames[$i]);
        $stmt->execute();
        $taskDifficultyResult = $stmt->get_result();
        $taskDifficultyRow = $taskDifficultyResult->fetch_assoc();
        $taskDifficulty = $taskDifficultyRow['difficulty'];

        // Update "difficulty_Elo" for the user in "dle_users"
        $updateEloQuery = "UPDATE dle_users SET difficulty_Elo = difficulty_Elo + ? WHERE user_id = ?";
        $stmt = $conn->prepare($updateEloQuery);
        $stmt->bind_param("ii", $taskDifficulty, $userIds[$currentRegressor]);
        $stmt->execute();

        $regressionsLeftUntilTheNextRegressor--;
    }
}

// Select data from "clean_up" and "dle_users" tables and display in a table
$selectDataQuery = "SELECT clean_up.name, id, who_id, when_, active, difficulty, date_Checked, dle_users.name AS uname
    FROM clean_up
    LEFT JOIN dle_users ON dle_users.user_id = who_id
    ORDER BY difficulty DESC";

if ($result = $conn->query($selectDataQuery)) {
    $rowsCount = $result->num_rows;
    echo "<p>Получено объектов: $rowsCount</p>";
    echo "<table><tr><th>id</th><th>name</th><th>username</th><th>who_id</th></tr>";

    foreach ($result as $row) {
        $appliedStyle = "background-color:#FF5C5C";
        $query = "SELECT name FROM dle_users WHERE user_id = ?";
        $stmt = $conn->prepare($query);
        $stmt->bind_param("i", $row["who_id"]);
        $stmt->execute();
        $res = $stmt->get_result();
        $resArray = mysqli_fetch_array($res);

        date_default_timezone_set('Africa/Cairo');
        $today = date('Y-m-d');

        $query = "SELECT time_end FROM log_action WHERE task_id = 5 AND user_id = ?";
        $stmt = $conn->prepare($query);
        $stmt->bind_param("i", $row["who_id"]);
        $stmt->execute();
        $resEndTime = $stmt->get_result();
        $resEndTimeArray = mysqli_fetch_array($resEndTime);
        $givenDatetime = $resEndTimeArray['time_end'];

        $givenDate = date('Y-m-d', strtotime($givenDatetime));

        if ($givenDate == $today) {
            $taskAccomplishedToday = true;

            if ($row['date_Checked'] == $today) {
                $checkedToday = true;
                $reset = false;
            } else {
                $reset = true;
            }
        } else {
            $taskAccomplishedToday = false;
        }

        if ($reset) {
            $stmt = mysqli_prepare($conn, "UPDATE clean_up SET checked = ?, date_Checked = ? WHERE who_id = ?");
            $whoIdSend = mysqli_real_escape_string($conn, $whoId);
            $completionStatusSend = 0;
            $dateChecked = gmdate('Y-m-d H:i:s');
            mysqli_stmt_bind_param($stmt, "iss", $completionStatusSend, $dateChecked, $row['who_id']);
            if (mysqli_stmt_execute($stmt)) {
                $successMsg = 'Record updated successfully';
            } else {
                $errorMsg = 'Error updating record: ' . mysqli_error($conn);
            }
        }

        $query = "SELECT id FROM log_action WHERE task_id = 5 AND user_id = ?";
        $stmt = $conn->prepare($query);
        $stmt->bind_param("i", $row["who_id"]);
        $stmt->execute();
        $res = $stmt->get_result();

        if ($res->num_rows > 0 && $taskAccomplishedToday == true) {
            $query = "SELECT checked FROM clean_up WHERE checked = 1 AND id = ?";
            $stmt = $conn->prepare($query);
            $stmt->bind_param("i", $row["id"]);
            $stmt->execute();
            $res = $stmt->get_result();
            if ($res->num_rows > 0 && $checkedToday) {
                $appliedStyle = "background-color:lightblue";
            } else {
                $appliedStyle = "background-color:lightgreen";
            }
        }

        echo "<tr>";
        echo "<td>" . $row["id"] . "</td>";
        echo "<td class='locations' onclick='updateCompletionStatus(" . $row["id"] . ")'>" . $row["name"] . "</td>";
        echo "<td style='$appliedStyle' class='hobbits' data-userid=" . $row["who_id"] . " onclick='jf(" . $row["id"] . ")' id=" . $row["id"] . ">" . $resArray[0] . "</td> ";
        echo "<td>" . $row["who_id"] . "</td>";
        echo "</tr>";
    }
    echo "</table>";
echo '<button onclick="resetELOscores()">Reset ELO here</button>';
} else {
    echo "Error: " . $conn->error;
}

// Close database connection
$conn->close();

?>
